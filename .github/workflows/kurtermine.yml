name: Auto deploy kurtermine files to production

on:
  push:
    branches:
      - main
    paths:
      - '_data/kurtermine_badwurzach.yml'
      - '_data/kurtermine_lossburg.yml'
      - '_data/kurtermine_scheidegg.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if only allowed kurtermine files were changed
        run: |
          ALLOWED_FILES="kurtermine_badwurzach.yml kurtermine_lossburg.yml kurtermine_scheidegg.yml"
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)

          for file in $CHANGED_FILES; do
            if ! echo "$ALLOWED_FILES" | grep -qw "$file"; then
              echo "❌ Nicht erlaubte Datei geändert: $file"
              exit 1
            fi
          done

          echo "✅ Nur erlaubte kurtermine-Dateien geändert"

      - name: Push to production
        run: |
          git checkout production
          git cherry-pick main
          git push origin production

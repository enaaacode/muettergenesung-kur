---
layout: default
title: "Kuranmeldung – Evangelische Müttergenesung in Württemberg"
description: "Wir freuen uns über Ihre Anmeldung."
---

<script
  src="{{ 'assets/js/formular-kind-abfrage.js' | relative_url }}"
  defer
></script>
<script
  src="{{ 'assets/js/formular-query-parameter.js' | relative_url }}"
  defer
></script>
<script
  src="{{ 'assets/js/formular-krankenkasse-sonstige.js' | relative_url }}"
  defer
></script>

<!-- Hauptcontainer für die Anmeldeseite -->
<div class="headline-wrapper">
  <div class="headline_eyebrow centered">
    <!-- Navigationslink zurück zu den Kurterminen -->
    <a
      href="/zeta-9-temp"
      class="button text"
      aria-label="Zurück zur Übersicht der Kurtermine"
    >
      &larr; Zurück zu den Kurterminen
    </a>

    <h1>Kuranfrage (Test)</h1>
    <p>
      Anfrage für den Kurtermin vom
      <strong id="datum-query"></strong> in <span id="ort-query"></span>
    </p>
  </div>
</div>

<!-- Formularbereich -->
<div class="outter-wrapper" id="form-section">
  <form
    action="mailto:info@muettergenesung-kur.de"
    method="post"
    enctype="text/plain"
    class="kurtermin-anfrage-formular"
    aria-labelledby="form-heading"
  >
    <div class="form-container" id="hinweis-form-container">
      <p>
        <strong>Hinweis:</strong>
        <span id="hinweis-query"></span>
      </p>
    </div>
    <!-- Versteckte Überschrift für Screenreader, die das Formular beschreibt -->
    <h2 id="form-heading" class="visually-hidden">Formular für Kuranfrage</h2>

    <!-- Container für persönliche Daten -->
    <div class="form-container">
      <h3>Persönliche Daten</h3>

      <!-- Vorname Eingabefeld -->
      <div class="form-field">
        <label for="vorname">
          Vorname
          <span class="visually-hidden">Pflichtfeld</span>
        </label>
        <input
          type="text"
          id="vorname"
          name="Vorname"
          required
          aria-required="true"
          autocomplete="given-name"
        />
      </div>

      <!-- Nachname Eingabefeld -->
      <div class="form-field">
        <label for="nachname">
          Nachname
          <span class="visually-hidden">Pflichtfeld</span>
        </label>
        <input
          type="text"
          id="nachname"
          name="Nachname"
          required
          aria-required="true"
          autocomplete="family-name"
        />
      </div>

      <!-- Geburtsdatum Eingabefeld -->
      <div class="form-field">
        <label for="geburtsdatum">
          Geburtsdatum
          <span class="visually-hidden">Pflichtfeld</span>
        </label>
        <input
          type="date"
          id="geburtsdatum"
          name="Geburtsdatum"
          required
          aria-required="true"
          autocomplete="bday"
        />
      </div>

      <!-- Geschlecht Eingabefeld -->
      <div class="form-field">
        <label for="geschlecht">
          Geschlecht
          <span class="visually-hidden">Pflichtfeld</span>
        </label>
        <select id="geschlecht" name="Geschlecht" required>
          <option value="w">Weiblich</option>
          <option value="d">Divers</option>
        </select>
      </div>

      <!-- Familienstand Eingabefeld -->
      <div class="form-field">
        <label for="familienstand">
          Familienstand
          <span class="visually-hidden">Pflichtfeld</span>
        </label>
        <select id="familienstand" name="Familienstand" required>
          <option value="">Bitte wählen</option>
          <option value="ledig">Ledig</option>
          <option value="verheiratet">Verheiratet</option>
          <option value="geschieden">Geschieden</option>
          <option value="verwitwet">Verwitwet</option>
        </select>
      </div>

      <!-- E-Mail Eingabefeld -->
      <div class="form-field">
        <label for="email">
          E-Mail-Adresse
          <span class="visually-hidden">Pflichtfeld</span>
        </label>
        <input
          type="email"
          id="email"
          name="E-Mail"
          required
          aria-required="true"
          autocomplete="email"
        />
      </div>

      <!-- Telefonnummer Eingabefeld -->
      <div class="form-field">
        <label for="telefon">
          Telefonnummer
          <span class="visually-hidden">Pflichtfeld</span>
        </label>
        <input
          type="tel"
          id="telefon"
          name="Telefon"
          required
          aria-required="true"
          autocomplete="tel"
        />
      </div>
    </div>

    <!-- - - - - - - - - - - - - - - - - - - - -
     Container für Versicherungsinformationen 
     - - - - - - - - - - - - - - - - - - - - -->

    <div class="form-container">
      <h3>Versicherungs&shy;informationen</h3>

      <!-- Krankenkasse Auswahlfeld -->
      <div class="form-field">
        <label for="krankenkasse">
          Krankenkasse
          <span class="visually-hidden">Pflichtfeld</span>
        </label>

        <select
          id="krankenkasse"
          name="Krankenkasse"
          required
          aria-required="true"
          onchange="toggleOtherKasse(this, 'krankenkasse_sonstige')"
        >
          <option value="" disabled selected>Bitte auswählen</option>
          <option value="AOK">AOK</option>
          <option value="TK">Techniker Krankenkasse (TK)</option>
          <option value="Barmer">Barmer</option>
          <option value="DAK">DAK-Gesundheit</option>
          <option value="IKK">IKK</option>
          <option value="BKK">BKK</option>
          <option value="KKH">KKH</option>
          <option value="Sonstige">Sonstige</option>
        </select>

        <!-- Freitextfeld, erscheint nur bei "Sonstige" // wird mit JS eingeblendet -->
        <input
          type="text"
          id="krankenkasse_sonstige"
          name="Krankenkasse_Sonstige"
          placeholder="Bitte Krankenkasse eintragen"
          style="display: none; margin-top: 0.5em"
        />
      </div>

      <!-- Fieldset für Bewilligungsabfrage -->
      <fieldset class="form--einrichtungsabfrage-container">
        <legend>
          Haben Sie bereits eine Bewilligung von Ihrer Krankenkasse?
          <span class="visually-hidden">Pflichtfeld</span>
        </legend>

        <!-- Option "Ja" -->
        <div class="radio-option">
          <input
            type="radio"
            id="bewilligung-ja"
            name="bewilligung"
            value="ja"
            required
            aria-required="true"
          />
          <label for="bewilligung-ja">Ja</label>
        </div>

        <!-- Option "Nein" -->
        <div class="radio-option">
          <input
            type="radio"
            id="bewilligung-nein"
            name="bewilligung"
            value="nein"
          />
          <label for="bewilligung-nein">Nein</label>
        </div>
      </fieldset>
    </div>

    <!-- - - - - - - - - - - - - - - - - - - - -
     Container für Adressdaten
     - - - - - - - - - - - - - - - - - - - - -->

    <div class="form-container">
      <h3>Ihre Anschrift</h3>

      <!-- Straße und Hausnummer Eingabefeld -->
      <div class="form-field">
        <label for="anschrift">
          Straße und Hausnummer
          <span class="visually-hidden">Pflichtfeld</span>
        </label>
        <input
          type="text"
          id="anschrift"
          name="Anschrift"
          required
          aria-required="true"
          autocomplete="street-address"
        />
      </div>

      <!-- Postleitzahl Eingabefeld -->
      <div class="form-field">
        <label for="plz">
          Postleitzahl
          <span class="visually-hidden">Pflichtfeld</span>
        </label>
        <input
          type="text"
          id="plz"
          name="plz"
          inputmode="numeric"
          pattern="\d{5}"
          maxlength="5"
          required
          aria-required="true"
          autocomplete="postal-code"
        />
      </div>

      <!-- Ort Eingabefeld -->
      <div class="form-field">
        <label for="ort">
          Ort
          <span class="visually-hidden">Pflichtfeld</span>
        </label>
        <input
          type="text"
          id="ort"
          name="Ort"
          required
          aria-required="true"
          autocomplete="address-level2"
        />
      </div>
    </div>

    <!-- - - - - - - - - - - - - - - - - - - - -
     Container für Gesundheitsdaten
     - - - - - - - - - - - - - - - - - - - - -->
    <div class="form-container">
      <h3>Gesundheits&shy;daten</h3>

      <!-- Körpergröße und Gewicht in einer Zeile -->
      <div class="form-row">
        <div class="form-field">
          <label for="koerpergroesse"> Ihre Körpergröße (cm) </label>
          <input
            type="number"
            id="koerpergroesse"
            name="Körpergröße"
            min="0"
            step="1"
            inputmode="numeric"
          />
        </div>

        <div class="form-field">
          <label for="gewicht"> Ihr Gewicht (kg) </label>
          <input
            type="number"
            id="gewicht"
            name="Gewicht"
            min="0"
            step="0.1"
            inputmode="decimal"
          />
        </div>
      </div>

      <!-- Psychosoziale Belastungen -->
      <div class="form-field">
        <label for="belastungen">
          Welche besonderen psychosozialen Belastungen bringen Sie mit?
          (optional)
        </label>
        <textarea
          id="belastungen"
          name="Psychosoziale Belastungen"
          rows="4"
          placeholder="Bitte beschreiben Sie Ihre aktuelle Situation..."
        ></textarea>
      </div>

      <!-- Besonderheiten und Risiken -->
      <div class="form-field">
        <label for="risiken">
          Besonderheiten und Risiken, die wir bei Ihnen, Ihrem Kind oder Ihren
          Kindern beachten müssen (optional)
        </label>
        <textarea
          id="risiken"
          name="Besonderheiten und Risiken"
          rows="4"
          placeholder="z.B. gesundheitliche Einschränkungen, besondere Bedürfnisse..."
        ></textarea>
      </div>
    </div>
    <!-- - - - - - - - - - - - - - - - - - - - -
     Container für Kinderinformationen
     - - - - - - - - - - - - - - - - - - - - -->
    <div class="form-container">
      <h3>Kinder</h3>

      <small
        id="hinweis-query-zwei"
        style="
          color: var(--color-pink);
          margin-top: -1rem;
          margin-bottom: -1rem;
        "
      ></small>

      <!-- Anzahl der Kinder Eingabefeld -->
      <div class="form-field">
        <label for="kinder">
          Mit wie vielen Kindern kommen Sie zur Kur?
          <span class="visually-hidden">Pflichtfeld</span>
        </label>
        <input
          value="0"
          type="number"
          id="kinder"
          name="Kinder"
          min="0"
          max="5"
          required
          aria-required="true"
          onchange="showKinderFelder(this.value)"
        />
      </div>
    </div>

    <!-- Dynamischer Bereich für Kinderdetails -->
    <div id="kinder-felder" aria-live="polite"></div>

    <!-- - - - - - - - - - - - - - - - - - - - -
     Container für Alternativtermin
     - - - - - - - - - - - - - - - - - - - - -->
    <div class="form-container">
      <h3>Alternativ&shy;termin</h3>

      <div class="form-field">
        <label for="alternativtermin">
          Alternativtermine (falls es mit Ihrem Wunschtermin nicht klappen
          sollte) (optional)
        </label>
        <textarea
          id="alternativtermin"
          name="Alternativtermin"
          rows="4"
          placeholder="Hier können Sie uns Ihre Alternativtermine mitteilen"
        ></textarea>
      </div>
    </div>

    <div class="form-container">{% include datenschutz-checkbox.html %}</div>
    <!-- Versteckte Felder für Kurtermin-Daten -->
    <input type="hidden" name="Kurtermin" value="{{ page.datum }}" />
    <input type="hidden" name="Hinweis" value="{{ page.hinweis }}" />

    <div id="cap-container">
      <cap-widget
        id="cap"
        data-cap-i18n-verifying-label="Wird Verifiziert..."
        data-cap-i18n-initial-state="Ich bin ein Mensch"
        data-cap-i18n-solved-label="Ich bin ein Mensch"
        data-cap-api-endpoint="http://localhost:3000/capture/"
      ></cap-widget>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@cap.js/widget"></script>
    <script>
      // an das Hauptformular binden
      const form = document.querySelector(".kurtermin-anfrage-formular");
      form.addEventListener("submit", async (event) => {
        event.preventDefault();

        // FormData vom echten Formular lesen (inkl. cap-widget token)
        const formData = new FormData(form);

        const data = {
          // Beispiel: mappe Felder aus dem großen Formular
          name: formData.get("Vorname") + " " + formData.get("Nachname"),
          captureToken: formData.get("cap-token"),
          // ...weitere Felder nach Bedarf...
        };

        const response = await fetch("http://localhost:3000/kuranmeldung", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        });

        if (response.ok) {
          // TODO: Anpassen
          alert("Form submitted successfully!");
        } else {
          alert("Form submission failed.");
        }
      });
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const form = document.querySelector(".kurtermin-anfrage-formular");
        if (!form) return;

        const submitBtn = form.querySelector('button[type="submit"]');
        if (!submitBtn) return;
        submitBtn.disabled = true;

        const requiredFields = Array.from(form.querySelectorAll("[required]"));

        // Prüft ob Captcha-Token vorhanden ist
        function hasCaptchaToken() {
          const tokenInput = form.querySelector('input[name="cap-token"]');
          return Boolean(
            tokenInput && tokenInput.value && tokenInput.value.trim().length
          );
        }

        // zentrale Validierungsfunktion
        function updateSubmitState() {
          // native validity check + captcha
          const formValid = form.checkValidity();
          submitBtn.disabled = !(formValid && hasCaptchaToken());
        }

        // Listener für alle required-Felder
        requiredFields.forEach((el) => {
          el.addEventListener("input", updateSubmitState, { passive: true });
          el.addEventListener("change", updateSubmitState, { passive: true });
        });

        // Beobachter: wenn das Cap-Widget ein hidden input einfügt / ändert
        const capContainer = document.getElementById("cap-container");
        if (capContainer) {
          const mutationObserver = new MutationObserver(() => {
            // falls token-input gerade angelegt wurde, lauschen wir auf input-events
            const tokenInput = form.querySelector('input[name="cap-token"]');
            if (tokenInput) {
              tokenInput.addEventListener("input", updateSubmitState, {
                passive: true,
              });
            }
            updateSubmitState();
          });
          mutationObserver.observe(capContainer, {
            childList: true,
            subtree: true,
            attributes: true,
            attributeFilter: ["value"],
          });
        }

        // Fallback: kurze Polling-Phase für den Fall, dass Widget Token später schreibt
        const pollingInterval = setInterval(() => {
          updateSubmitState();
        }, 500);
        // nach 60s Polling stoppen
        setTimeout(() => clearInterval(pollingInterval), 60000);

        // Schutz im Submit-Handler: nochmals prüfen und sinnvolle Fehlermeldung
        form.addEventListener("submit", async (e) => {
          if (!form.checkValidity() || !hasCaptchaToken()) {
            e.preventDefault();
            updateSubmitState();
            // Nutzerfreundliche Hinweise
            if (!form.checkValidity()) {
              // Fokus auf erstes invalide Feld
              const firstInvalid = form.querySelector(":invalid");
              if (firstInvalid) firstInvalid.focus();
              alert("Bitte füllen Sie alle Pflichtfelder korrekt aus.");
            } else {
              alert(
                "Bitte lösen Sie das Captcha, bevor Sie die Anfrage absenden."
              );
            }
            return;
          }

          // Falls du einen eigenen Fetch-Submit verwendest: disable button und prevent double-submit
          submitBtn.disabled = true;
          submitBtn.setAttribute("aria-busy", "true");

          // Wenn dein bestehender submit-Handler per JS fetch nutzt, belasse hier die Logik.
          // Bei mailto-Formaction wird das native Verhalten weiter ausgeführt.
        });
      });
    </script>

    <!-- Submit-Button -->
    <div class="form-actions kuranfrage">
      <button type="submit" class="button primary">Anfrage absenden</button>
    </div>
  </form>
</div>
